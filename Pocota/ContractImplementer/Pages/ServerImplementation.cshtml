@page
@using Net.Leksi.Pocota.Common;
@using Net.Leksi.Pocota.Common.Generic;
@using Net.Leksi.Pocota.Server;
@model ClassModel

@Html.Partial("Header", Model)

public class @Model.ClassName: @Html.Raw(string.Join(", ", Model.Interfaces))
{
@if(Model.PrimaryKey is { })
{
    <text>    public class PrimaryKeyClass: @Model.PrimaryKey.Name
    {
        private readonly @Model.ClassName _owner;
        public override object? this[int index]
        {
            get
            {
                switch (index)
                {
    @for (int i = 0; i < Model.PrimaryKey!.Parts.Count; ++i)
    {
        if(Model.PrimaryKey!.Parts[i].Property is {})
        {
            <text>                    case @i:
            @if(!Model.PrimaryKey!.Parts[i].IsProperty)
            {
                 <text>                       return ((@Model.PrimaryKey!.Parts[i].PrimaryKeyClassName)((@nameof(IEntity))_owner.@Model.PrimaryKey!.Parts[i].Property).@Model.PrimaryKey!.Parts[i].KeyReference;
</text>
            }
            else
            {
                 <text>                       return _owner.@Model.PrimaryKey!.Parts[i].PropertyField;
</text>
            }
</text>
        }
    }
                    default:
                        return base[index];
                }
            }
            set
            {
                switch (index)
                {
    @for (int i = 0; i < Model.PrimaryKey!.Parts.Count; ++i)
    {
        if(Model.PrimaryKey!.Parts[i].Property is {})
        {
            <text>                    case @i:
            @if(Model.PrimaryKey!.Parts[i].IsProperty)
            {
                <text>                        @Model.PrimaryKey!.Parts[i].Type? value@{}@i = value as @Model.PrimaryKey!.Parts[i].Type@Model.PrimaryKey!.Parts[i].AsTypeAsk;
                        if (value is null || value@{}@i is null)
                        {
                            throw new @nameof(InvalidCastException)@{}();
                        }
                        _owner.@Model.PrimaryKey!.Parts[i].Property = (@Model.PrimaryKey!.Parts[i].Type)value@{}@i!;
                        break;
</text>
            }
            else
            {
                <text>                        @Model.PrimaryKey!.Parts[i].Type? value@{}@i = value as @Model.PrimaryKey!.Parts[i].Type@Model.PrimaryKey!.Parts[i].AsTypeAsk;
                        if (value is null || value@{}@i is null)
                        {
                            throw new @nameof(InvalidCastException)@{}();
                        }
                        ((@Model.PrimaryKey!.Parts[i].PrimaryKeyClassName)((@nameof(IEntity))_owner.@Model.PrimaryKey!.Parts[i].Property).@Model.PrimaryKey!.Parts[i].KeyReference = (@Model.PrimaryKey!.Parts[i].Type)value@{}@i!;
                        break;
</text>
            }
</text>
        }
    }
                    default:
                        base[index] = value;
                        break;
                }
            }
        }
        public override object? this[string name]
        {
            get
            {
                switch (name)
                {
    @for (int i = 0; i < Model.PrimaryKey!.Parts.Count; ++i)
    {
        if(Model.PrimaryKey!.Parts[i].Property is {})
        {
            <text>                    case @Html.Raw($"\"{@Model.PrimaryKey!.Parts[i].Name}\""):
            @if(!Model.PrimaryKey!.Parts[i].IsProperty)
            {
                        <text>                        return ((@Model.PrimaryKey!.Parts[i].PrimaryKeyClassName)((@nameof(IEntity))_owner.@Model.PrimaryKey!.Parts[i].Property).@Model.PrimaryKey!.Parts[i].KeyReference;
</text>
            }
            else
            {
                        <text>                        return _owner.@Model.PrimaryKey!.Parts[i].PropertyField;
</text>
            }
</text>
        }
    }
                    default:
                        return base[name];
                }
            }
            set
            {
                switch(name)
                {
    @for (int i = 0; i < Model.PrimaryKey!.Parts.Count; ++i)
    {
        if(Model.PrimaryKey!.Parts[i].Property is {})
        {
            <text>                    case @Html.Raw($"\"{@Model.PrimaryKey!.Parts[i].Name}\""):
            @if(Model.PrimaryKey!.Parts[i].IsProperty)
            {
                <text>                        @Model.PrimaryKey!.Parts[i].Type? value@{}@i = value as @Model.PrimaryKey!.Parts[i].Type@Model.PrimaryKey!.Parts[i].AsTypeAsk;
                        if (value is null || value@{}@i is null)
                        {
                            throw new @nameof(InvalidCastException)@{}();
                        }   
                        _owner.@Model.PrimaryKey!.Parts[i].Property = (@Model.PrimaryKey!.Parts[i].Type)value@{}@i!;
                        break;
</text>
            }
            else
            {
                <text>                        @Model.PrimaryKey!.Parts[i].Type? value@{}@i = value as @Model.PrimaryKey!.Parts[i].Type@Model.PrimaryKey!.Parts[i].AsTypeAsk;
                        if (value is null || value@{}@i is null)
                        {
                            throw new @nameof(InvalidCastException)@{}();
                        }
                        ((@Model.PrimaryKey!.Parts[i].PrimaryKeyClassName)((@nameof(IEntity))_owner.@Model.PrimaryKey!.Parts[i].Property).@Model.PrimaryKey!.Parts[i].KeyReference = (@Model.PrimaryKey!.Parts[i].Type)value@{}@i!;
                        break;
</text>
            }
</text>
        }
    }
                    default:
                        base[name] = value;
                        break;
                }
            }
        }
    @foreach (PrimaryKeyPartModel pkpm in Model.PrimaryKey!.Parts.Where(p => p.KeyReference is {}))
    {
        <text>        public override @Html.Raw(pkpm.Type)? @pkpm.Name 
        {
            get
            {
        @if(!@pkpm.IsProperty)
        {
                    <text>
                        return ((@pkpm.PrimaryKeyClassName)((@nameof(IEntity))_owner.@pkpm.Property).@pkpm.KeyReference;
</text>
        }
        else
        {
            <text>                       return _owner.@pkpm.Property;
</text>
        }
            }
            set
            {
        @if(pkpm.IsProperty)
        {
            <text>                @pkpm.Type? value1 = value as @pkpm.Type@pkpm.AsTypeAsk;
                if (value is null || value1 is null)
                {
                    throw new @nameof(InvalidCastException)@{}();
                }
                _owner.@pkpm.Property = (@pkpm.Type)value1!;
</text>
        }
        else
        {
            <text>                @pkpm.Type? value1 = value as @pkpm.Type@pkpm.AsTypeAsk;
                if (value is null || value1 is null)
                {
                    throw new @nameof(InvalidCastException)@{}();
                }
                ((@pkpm.PrimaryKeyClassName)((@nameof(IEntity))_owner.@pkpm.Property).@pkpm.KeyReference = (@pkpm.Type)value1!;
</text>
        }
            }
        }
</text>
    }
        
        public override bool IsAssigned 
        {
            get
            {
                return @for (int i = 0; i < Model.PrimaryKey!.Parts.Count; ++i)
    {       
        if(Model.PrimaryKey!.Parts[i].Property is {})
        {
                <text>s_@{}@Model.PrimaryKey!.Parts[@i].PropertyName@{}Property.IsSet(_owner) 
                    && </text>
        }
    }base.IsAssigned;
            }
        }
        
        internal PrimaryKeyClass(@Model.ClassName owner)
        {
            _owner = owner;
        }
    }
</text>
}

#region Property classes

@foreach(PropertyModel pm in Model.Properties)
{
    if(!string.IsNullOrEmpty(pm.Name) || Model.PocoKind is not PocoKind.Extender)
    {
        <text>    public class @pm.PropertyClass: I@{}@if(Model.PocoKind is PocoKind.Entity || Model.PocoKind is PocoKind.Extender)
            {
            if(Model.PocoKind is PocoKind.Entity && string.IsNullOrEmpty(pm.Name)){<text>Self</text>}<text>Entity</text>
            }Property
    {
        public string Name => "@pm.Name";

        public Type Type => typeof(@Html.Raw(pm.Type));

        public bool IsNullable => @if(!string.IsNullOrEmpty(pm.Nullable)){<text>true</text>}else{<text>false</text>};

        public bool IsReadonly => @if(pm.IsReadonly){<text>true</text>}else{<text>false</text>};

        public PocoKind PocoKind => @nameof(PocoKind)@{}.@pm.PocoKind;

        public bool IsCollection => @if(pm.IsReadonly){<text>true</text>}else{<text>false</text>};

        public Type? ItemType => @if(pm.ItemType is null){<text>null</text>}else{<text>typeof(@Html.Raw(pm.ItemType))</text>};

        public object? GetValue(object target)
        {
            if(target is @Model.ClassName obj)
            {
                return obj@{}@if(!string.IsNullOrEmpty(pm.Name)){<text>.Get@{}@pm.Name@{}()</text>};
            }
            throw new @nameof(ArgumentException)@{}(string.Format(s_invalidTarget, target is null ? "null" : target.GetType(), typeof(@Model.ClassName)));
        }

        public bool IsSet(object target)
        {
            if(target is @Model.ClassName obj)
            {
                return @if(!string.IsNullOrEmpty(pm.Name)){<text>obj.@pm.FieldName@{}IsSet</text>}else{<text>true</text>};
            }
            throw new @nameof(ArgumentException)@{}(string.Format(s_invalidTarget, target is null ? "null" : target.GetType(), typeof(@Model.ClassName)));
        }

        public void SetValue(object target, object? value)
        {
            if(target is @Model.ClassName obj)
            {
                if(value is @Html.Raw(pm.Type)@if(!string.IsNullOrEmpty(pm.Nullable)){<text> || value is null</text>})
                {
    @if(!string.IsNullOrEmpty(pm.Name))
    {
        <text>                    obj.Set@{}@pm.Name@{}((@Html.Raw(pm.Type)@pm.Nullable)value);
</text>
    }
                }
                else
                {
                    throw new @nameof(ArgumentException)@{}(string.Format(s_invalidValue, value is null ? "null" : value.GetType(), typeof(@Html.Raw(pm.Type))));
                }
            }
            else
            {
                throw new @nameof(ArgumentException)@{}(string.Format(s_invalidTarget, target is null ? "null" : target.GetType(), typeof(@Model.ClassName)));
            }
        }
        @if(Model.PocoKind is PocoKind.Entity || Model.PocoKind is PocoKind.Extender)
        {
            <text>        public @nameof(PropertyAccessMode) GetAccess(object target)
        {
            if(target is @Model.ClassName obj)
            {
                return obj.@if(!string.IsNullOrEmpty(pm.Name)){<text>@pm.FieldName@{}AccessMode</text>}else{<text>_accessMode</text>};
            }
            throw new @nameof(ArgumentException)@{}(string.Format(s_invalidTarget, target is null ? "null" : target.GetType(), typeof(@Model.ClassName)));
        }

        public void SetAccess(object target, @nameof(PropertyAccessMode) value)
        {
            if(target is @Model.ClassName obj)
            {
                if(!obj._isAccessChecking){
                    throw new @nameof(ArgumentException)@{}(s_cannotSetAccess);
                }
                obj.@if(!string.IsNullOrEmpty(pm.Name)){<text>@pm.FieldName@{}AccessMode</text>}else{<text>_accessMode</text>} = value;
            }
            throw new @nameof(ArgumentException)@{}(string.Format(s_invalidTarget, target is null ? "null" : target.GetType(), typeof(@Model.ClassName)));
        }
</text>
        }
        @if(string.IsNullOrEmpty(pm.Name) && pm.PocoKind is PocoKind.Entity)
        {
            <text>        public @nameof(IPrimaryKey) CreatePrimaryKey(@nameof(IServiceProvider) serviceProvider)
        {
            return (@Model.PrimaryKey.Name)serviceProvider.GetRequiredService@{}@Html.Raw($"<{nameof(IPrimaryKey<object>)}<{Model.Interface}>>")@{}();
        }
</text>
        }
    }
</text>
    }
}

#endregion Property classes

    private const string s_alreadyDelivered = "The property {0}.{1} is already delivered!";
    private const string s_accessAlreadyChecked = "The access to {0} is already checked!";
    private const string s_isNotSet = "The property {0}.{1} is not set!";
    private const string s_invalidTarget = "Invalid target: {0}, {1} expected!";
    private const string s_invalidValue = "Invalid value: {0}, {1} expected!";
    private const string s_cannotSetAccess = "Cannot set access mode at this point!";
#region Property fields
@foreach (PropertyModel pm in Model.Properties)
{
    <text>    private static @pm.PropertyClass @pm.PropertyField = new();
</text>
}
#endregion Property fields

#region Fields
    private readonly @nameof(IServiceProvider) _serviceProvider;
@if (Model.PocoKind is PocoKind.Entity)
{
    <text>    private @nameof(PropertyAccessMode) _accessMode = PropertyAccessMode.Full;
    private bool _isAccessChecked = false;
    protected internal bool _isAccessChecking = false;
    private readonly @nameof(EntityHeart) _heart;
</text>
}
else if (Model.PocoKind is PocoKind.Envelope)
{
    <text>    private readonly @nameof(PocoHeart) _heart;
</text>
}
@foreach(PropertyModel pm in Model.Properties)
{
    <text>    private @Html.Raw(pm.Type)@pm.Nullable @pm.FieldName = @if(pm.IsClass || pm.PocoKind is not PocoKind.NotAPoco || pm.IsCollection || !string.IsNullOrEmpty(@pm.Nullable))
    {
        <text>null@{}@if(string.IsNullOrEmpty(@pm.Nullable)){<text>!</text>}</text>
    } 
    else 
    {
        <text>default</text>
    };
    @if (Model.PocoKind is PocoKind.Entity || Model.PocoKind is PocoKind.Extender)
    {
        <text>    private PropertyAccessMode @pm.FieldName@{}AccessMode = PropertyAccessMode.Full;
</text>
    }
    private bool @pm.FieldName@{}IsSet = false;
    private bool @pm.FieldName@{}IsDelivered = false;
</text>
}
@if(Model.PrimaryKey is { })
{
    <text>    private readonly PrimaryKeyClass _primaryKey;
</text>

}
#endregion Fields
#region Properties
@if (Model.PocoKind is PocoKind.Entity)
{
    <text>    protected @nameof(EntityHeart) Heart => _heart;
    protected bool IsAccessChecked => _isAccessChecked;
</text>
}
else if (Model.PocoKind is PocoKind.Envelope)
{
    <text>    protected @nameof(PocoHeart) Heart => _heart;
</text>
}
@if (Model.PrimaryKey is { })
{
    <text>    @nameof(IPrimaryKey) @nameof(IEntity)@{}.PrimaryKey => _primaryKey;
</text>

}
@if (Model.PocoKind is PocoKind.Entity)
{
    <text>    @nameof(PropertyAccessMode) @nameof(IEntity)@{}.AccessMode
    {
        get  => _accessMode;
        set 
        {
            if(!_isAccessChecking){
                throw new @nameof(InvalidOperationException)@{}(s_cannotSetAccess);
            }
            _accessMode = value;
        }
    }  
</text>
}
   
@foreach(PropertyModel pm in Model.Properties.Where(p => !string.IsNullOrEmpty(p.Name)))
{
    <text>    public virtual @Html.Raw(pm.Type)@pm.Nullable @pm.Name 
    {
        get => Get@{}@pm.Name@{}();
    @if(!pm.IsReadonly)
    {
        <text>        set => Set@{}@pm.Name@{}(value);
</text>
    }
    }
</text>
}
#endregion Properties
    public @Model.ClassName (@nameof(IServiceProvider) serviceProvider)@if (Model.PocoKind is PocoKind.Extender)
{
    <text>: base(serviceProvider)</text>
}
    {
        _serviceProvider = serviceProvider;
@if(Model.PocoKind is PocoKind.Entity || Model.PocoKind is PocoKind.Envelope)
{
    <text>        _heart = new(_serviceProvider);
</text>
}
@if(Model.PrimaryKey is { })
{
    <text>        _primaryKey = new(this);
</text>
}
    }
#region Methods
@if(Model.PocoKind is PocoKind.Entity)
{
    <text>    void @nameof(IEntity)@{}.CheckAccess()
    {
        if(!_isAccessChecked)
        {
            try 
            {
                _isAccessChecking = true;
    @if(Model.AccessProperties.Any())
    {
        <text>                if(@string.Join(" || ", Model.AccessProperties.Select(p => $"!{p.FieldName}IsSet")))
                {
                    throw new @nameof(InvalidOperationException)@{}("Not all access properties are set!");
                }
</text>
    }

        @foreach (PropertyModel ap in Model.AccessProperties.Where(p => p.PocoKind is PocoKind.Entity || p.PocoKind is PocoKind.Extender))
        {
            @if(ap.IsCollection)
            {
                <text>                foreach(@Html.Raw(ap.ItemType) item in @ap.FieldName@{})
                {
                    ((@nameof(IEntity))item).CheckAccess();
                }
</text>
            }
            else
            {
                <text>                ((@nameof(IEntity))@ap.FieldName).CheckAccess();
</text>
            }
        }
                _serviceProvider.GetRequiredService@{}@Html.Raw($"<{nameof(IAccessManager<object>)}<{Model.Interface}>>")@{}().CheckAccess(this);
                _isAccessChecked = true;
            }
            finally
            {
                _isAccessChecking = false;
            }
        }
    }
</text>
}
@foreach(PropertyModel pm in Model.Properties.Where(p => !string.IsNullOrEmpty(p.Name)))
{
    <text>    private void Set@{}@pm.Name@{}(@Html.Raw(pm.Type)@pm.Nullable value)
    {
    @if(string.IsNullOrEmpty(@pm.Nullable) && pm.IsClass)
    {
        <text>        if(value is null)
        {
            throw new @nameof(ArgumentNullException)@{}(nameof(@pm.Name));
        }
</text>
    }
        if(@pm.FieldName@{}IsDelivered)
        {
            throw new @nameof(InvalidOperationException)@{}(string.Format(s_alreadyDelivered, typeof(@Model.ClassName), nameof(@pm.Name)));
        }
    @if(Model.PocoKind is PocoKind.Entity || Model.PocoKind is PocoKind.Extender)
    {
        <text>        if(IsAccessChecked)
        {
            throw new @nameof(InvalidOperationException)@{}(string.Format(s_accessAlreadyChecked, typeof(@Model.ClassName)));
        }
</text>
    }
        if(value != @pm.FieldName)
        {
            @pm.FieldName = value @if(string.IsNullOrEmpty(@pm.Nullable) && pm.IsClass){<text>!</text>};
            @pm.FieldName@{}IsSet = true;
        }
    }
    @if(pm.IsAccess && !pm.IsCollection && pm.PocoKind is PocoKind.Entity)
    {
        <text>    private void @pm.Name@{}Changed@{}()
    {
        _isAccessChecked = false;
    }
</text>
    }
    private @Html.Raw(pm.Type)@pm.Nullable Get@{}@pm.Name@{}()
    {
        if(!@pm.FieldName@{}IsSet)
        {
            throw new @nameof(InvalidOperationException)@{}(string.Format(s_isNotSet, typeof(@Model.ClassName), nameof(@pm.Name)));
        }
        return @pm.FieldName;
    }
</text>
}
#endregion Methods

}