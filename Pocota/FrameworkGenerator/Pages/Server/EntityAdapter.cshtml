@page
@using Net.Leksi.Pocota
@using Net.Leksi.Pocota.FrameworkGenerator
@using Net.Leksi.Pocota.FrameworkGenerator.Pages.Server
@model EntityAdapterModel
@Html.Partial("Header", Model)

public class @Model.ClassName@{}(IPocoContext pocoContext)@if(Model.BaseClasses.Any()){<text>: @string.Join(", ", Model.BaseClasses)</text>}

{
    private const string s_primaryKeyNotSet = "Primary key is not set!";
    private const string s_primaryKeySet = "Primary key is set!";
    private readonly IPocoContext _pocoContext = pocoContext;
    private readonly @Model.EntityClassName? _source = null;
@foreach (PropertyModel pm in Model.Properties.Where(v => v.IsPrimaryKey).OrderBy(v => v.Name))
{
    <text>    private @Html.Raw(pm.TypeName) _@pm.Name = default!;
</text>
}
#region Properties
    object IEntityAdapter.Source => _source;
@foreach(PropertyModel pm in Model.Properties)
{
    <text>    public override @Html.Raw(pm.TypeName)@(pm.IsNullable ? "?" : string.Empty) @pm.Name 
    { 
        get
        {
    @if(pm.IsPrimaryKey)
    {
        <text>            if(_source is null && _@pm.Name is IEntityAdapter)
            {
                return _@pm.Name;
            }
            return _source.@pm.Name;
</text>
    }
    else
    {
        <text>            if(_source is {})
            {
                if(_@pm.Name is IEntityAdapter)
                {
                    return _@pm.Name;
                }
                return _source.@pm.Name;
            }
            throw new InvalidOperationException(s_primaryKeyNotSet);
</text>
    }
        }
        set
        {
    @if(pm.IsPrimaryKey)
    {
        <text>            if(_source is null)
            {
                _@pm.Name = value;
                if(((@nameof(IEntityAdapter))this).GetPrimaryKey().All(v => v != default))
                {
                    //todo ищем _source
                }
            }
            else
            {
                throw new InvalidOperationException(s_primaryKeySet);
            }
</text>
    }
    else
    {
        <text>            if(_source is {})
            {
                if(_@pm.Name is IEntityAdapter ea)
                {
                    @pm.Name = value;
                    _source.@pm.Name = ea.Source;
                }
                _source.@pm.Name = value;
            }
            else{
                throw new InvalidOperationException(s_primaryKeyNotSet);
            }
</text>
    }
        }
    }
</text>
}
#endregion Properties
    IEnumerable<object> @nameof(IEntityAdapter)@{}.GetPrimaryKey()
    {
@foreach (PropertyModel pm in Model.Properties.Where(v => v.IsPrimaryKey).OrderBy(v => v.Name))
{
    if(pm.IsPoco)
    {
        <text>        foreach (object pk in ((@nameof(IEntityAdapter))_@pm.Name).GetPrimaryKey())
        {
            yield return pk;
        }
</text>
    }
    else
    {
        <text>        yield return _@pm.Name;
</text>
    }
}
    }
}