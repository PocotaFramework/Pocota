@page
@using Net.Leksi.Pocota
@using Net.Leksi.Pocota.FrameworkGenerator
@using Net.Leksi.Pocota.FrameworkGenerator.Pages.Server
@model DtoModel
@Html.Partial("Header", Model)

public class @Model.ClassName@{}(IPocoContext pocoContext)@if(Model.BaseClasses.Any()){<text>: @string.Join(", ", Model.BaseClasses)</text>}

{
#region PropertiesClasses
@foreach (PropertyModel pm in Model.Properties)
{
    <text>    public class @pm.Name@{}PropertyClass: @(Model.PocoKind is PocoKind.Entity ? nameof(IEntityProperty) : nameof(IProperty))
    {
        public string Name => "@pm.Name";
        public Type Type => typeof(@Html.Raw(pm.TypeName));
        public Type ItemType => typeof(@Html.Raw(pm.ItemTypeName));
        public bool IsCollection => @(pm.IsCollection ? "true" : "false");
        public bool IsNullable => @(pm.IsNullable ? "true" : "false");
        public bool IsReadOnly => @(pm.IsReadOnly ? "true" : "false");
        public bool IsPoco  => @(pm.IsPoco ? "true" : "false");
        public object? GetValue(object obj)
        {
            return (obj as @Model.ClassName)?.Get@{}@pm.Name@{}Value();
        }
        public void SetValue(object obj, object? value)
        {
            (obj as @Model.ClassName)?.Set@{}@pm.Name@{}Value(value);
        }
    @if(Model.PocoKind is PocoKind.Entity)
    {
        <text>        public Access? GetAccess(object obj)
        {
            return (obj as @Model.ClassName)?.Get@{}@pm.Name@{}Access();
        }
        public void SetAccess(object obj, Access access)
        {
            (obj as @Model.ClassName)?.Set@{}@pm.Name@{}Access(access);
        }

</text>
    }
    }
</text>
}
#endregion PropertiesClasses
#region Fields
    private readonly IPocoContext _pocoContext = pocoContext;
@foreach (PropertyModel pm in Model.Properties)
{
    <text>    private @Html.Raw(pm.TypeName)@(pm.IsNullable ? "?" : string.Empty) _@pm.Name@(!pm.IsNullable && pm.Type.IsClass ? " = null!" : string.Empty);
    private Access _@pm.Name@{}Access = Access.Full;
</text>
}
#endregion Fields

#region Properties
@foreach(PropertyModel pm in Model.Properties)
{
    <text>    public override @Html.Raw(pm.TypeName)@(pm.IsNullable ? "?" : string.Empty) @pm.Name 
    { 
        get
        {
            return _@pm.Name;
        }
        set
        {
            if(_pocoContext.ProcessingStage is ProcessingStage.Building)
            {
                _@pm.Name = value;
            }
            else{
                throw  new InvalidOperationException("Not at Building stage!");
            }
        }
    }
</text>
}
#endregion Properties
#region SettersGetters
@foreach (PropertyModel pm in Model.Properties)
{
    <text>    private void Set@{}@pm.Name@{}Value(object? value)
    {
        if(_pocoContext.ProcessingStage is ProcessingStage.Deserialization)
        {
            _@pm.Name = (@Html.Raw(pm.TypeName))value!;
        }
        else{
            throw new InvalidOperationException("Not at Deserialization stage!");
        }
    }
    private @Html.Raw(pm.TypeName)@(pm.IsNullable ? "?" : string.Empty) Get@{}@pm.Name@{}Value()
    {
        if(_pocoContext.ProcessingStage is ProcessingStage.Serialization)
        {
            return _@pm.Name;
        }
        throw new InvalidOperationException("Not at Serialization stage!");
    }
    @if(Model.PocoKind is PocoKind.Entity)
    {
        <text>    private Access Get@{}@pm.Name@{}Access()
    {
        if(
            _pocoContext.ProcessingStage is ProcessingStage.Serialization
            || _pocoContext.ProcessingStage is ProcessingStage.Deserialization
            || _pocoContext.ProcessingStage is ProcessingStage.AccessGiving
        )
        {
            return _@pm.Name@{}Access;
        }
        throw new InvalidOperationException("Not at AccessGiving, Serialization or Deserialization stage!");
    }
    private void Set@{}@pm.Name@{}Access(Access access)
    {
        if(
            _pocoContext.ProcessingStage is ProcessingStage.AccessGiving
        )
        {
            _@pm.Name@{}Access = access;
        }
        else{
            throw new InvalidOperationException("Not at AccessGiving stage!");
        }
    }
</text>
    }
</text>
}
#endregion SettersGetters
}