@page
@using Net.Leksi.Pocota
@using Net.Leksi.Pocota.FrameworkGenerator
@using Net.Leksi.Pocota.FrameworkGenerator.Pages.Server
@using Net.Leksi.Pocota.Server
@model DtoModel
@Html.Partial("Header", Model)

public class @Model.ClassName@{}(IServiceProvider services)@if(Model.BaseClasses.Any()){<text>: @Html.Raw(string.Join(", ", Model.BaseClasses))</text>}

{
    private const string s_notSet = "Not set!";
    private const string s_invalidTargetType = "The argument target must have type @Model.FullName!";
    private const string s_notBuildingDeserialization = "Not at Building or Deserialization stage!";
    private const string s_alreadyUsed = "The value is already used!";
    private const string s_notSerialization = "Not at Serialization stage!";
@if (Model.PocoKind is PocoKind.Entity)
{
    <text>    private const string s_accessAlreadyDone = "The access is already done!";
    private const string s_primaryKey = "The Primary Key cannot be set indirectly!";
    private const string s_notAccessGiving = "Not at AccessGiving stage!";
</text>
}
#region PropertiesClasses
@foreach (PropertyModel pm in Model.Properties)
{
    <text>    public class @pm.Name@{}PropertyClass: @(Model.PocoKind is PocoKind.Entity ? nameof(IEntityProperty) : nameof(IProperty))
    {
        public string Name => "@pm.Name";
        public Type Type => typeof(@Html.Raw(pm.TypeName));
        public Type ItemType => typeof(@Html.Raw(pm.ItemTypeName));
        public bool IsCollection => @(pm.IsCollection ? "true" : "false");
        public bool IsNullable => @(pm.IsNullable ? "true" : "false");
        public bool IsReadOnly => @(pm.IsReadOnly ? "true" : "false");
        public @nameof(PocoKind) PocoKind  => @nameof(PocoKind).@pm.PocoKind;
        public object? GetValue(object target, bool setUsed)
        {
            if(target is @Model.ClassName obj)
            {
    @if (pm.IsSelf) 
    {
        <text>                return obj;
</text>
    }
    else
    {
        <text>                if(setUsed)
                {
                    obj._@pm.Name@{}Used = true;
                }
                return obj.@pm.Name;
</text>
    }
            }
            throw new ArgumentException(s_invalidTargetType);
        }
        public void SetValue(object target, object? value)
        {
    @if(pm.IsPrimaryKey)
    {
        <text>            throw new InvalidOperationException(s_primaryKey);
</text>
    }
    else
    {
        <text>            if(target is @Model.ClassName@{}@if(!pm.IsSelf){<text> obj</text>})
            {
        @if (!pm.IsSelf) 
        {
            <text>                obj.@pm.Name = (@Html.Raw(pm.TypeName)@(pm.IsNullable ? "?" : string.Empty))Convert.ChangeType(value, typeof(@Html.Raw(pm.TypeName)@(!pm.Type.IsClass && pm.IsNullable ? "?" : string.Empty)))@(!pm.IsNullable ? "!" : string.Empty);
</text>
        }
            }
            else
            {
                throw new ArgumentException(s_invalidTargetType);
            }
</text>
    }
        }
        public bool IsSet(object target)
        {
            if(target is @Model.ClassName@{}@if(!pm.IsSelf){<text> obj</text>})
            {
                return @if (pm.IsSelf) {<text>true</text>}else{<text>obj._@pm.Name@{}IsSet</text>};
            }
            throw new ArgumentException(s_invalidTargetType);
        }
    @if(Model.PocoKind is PocoKind.Entity)
    {
        <text>        public Access GetAccess(object target)
        {
            if(target is @Model.ClassName obj)
            {
                return obj._@pm.Name@{}Access;
            }
            throw new ArgumentException(s_invalidTargetType);
        }
        public void SetAccess(object target, Access access)
        {
            if(target is @Model.ClassName obj)
            {
                if(obj._processingInfo.ProcessingStage is ProcessingStage.AccessGiving)
                {
                    if(!obj._accessGiven)
                    {
                        obj._@pm.Name@{}Access = access;
                    }
                    else
                    {
                        throw new InvalidOperationException(s_accessAlreadyDone);
                    }
                }
                else
                {
                    throw new InvalidOperationException(s_notAccessGiving);
                }
            }
            else
            {
                throw new ArgumentException(s_invalidTargetType);
            }
        }

</text>
    }
    }
</text>
}
#endregion PropertiesClasses

#region Fields
@foreach (PropertyModel pm in Model.Properties)
{
    <text>    internal static readonly @pm.Name@{}PropertyClass s_@pm.Name@{}Property;
</text>
}
@if(Model.PocoKind is PocoKind.Entity)
{
    <text>    private static readonly PropertyUse s_propertyUse;
</text>
}
    private readonly IProcessingInfo _processingInfo = services.GetRequiredService<IProcessingInfo>();
@if (Model.PocoKind is PocoKind.Entity)
{
    <text>    private bool _accessGiven = false;
    private bool _changed = false;
</text>
}
@foreach (PropertyModel pm in Model.Properties)
{
    if (!pm.IsSelf)
    {
        <text>    private @Html.Raw(pm.TypeName)@(pm.IsNullable ? "?" : string.Empty) _@pm.Name@(!pm.IsNullable && pm.Type.IsClass ? " = null!" : string.Empty);
    private bool _@pm.Name@{}IsSet = false;    
    private bool _@pm.Name@{}Used = false;
</text>
    }
    
    @if(Model.PocoKind is PocoKind.Entity)
    {
        <text>    private Access _@pm.Name@{}Access = Access.Read | Access.Update@{}@if(pm.IsSelf){<text> | Access.Delete</text>};
</text>
    }
}
#endregion Fields

    static @Model.ClassName@{}()
    {
@foreach (PropertyModel pm in Model.Properties)
{
    <text>        s_@pm.Name@{}Property = new();
</text>
}
@if(Model.PocoKind is PocoKind.Entity)
{
    ViewDataDictionary vdd = new(ViewData);
    vdd["indentation"] = 8;
    <text>#region PropertyUse
        s_propertyUse = @Html.Partial("PropertyUse", Model.PropertyUse, vdd);
#endregion PropertyUse
</text>
}
    }

#region Properties
@if(Model.PocoKind is PocoKind.Entity)
{
    <text>    PropertyUse @nameof(IEntity)@{}.PropertyUse => s_propertyUse;
    PocoState  @nameof(IEntity)@{}.PocoState => _processingInfo.PocoState;
    bool @nameof(IEntity)@{}.Changed => _changed;
    Type @nameof(IEntity)@{}.PrimaryKeyType => typeof(IPrimaryKey<@Model.BaseClasses.First()>);
</text>
}
@foreach(PropertyModel pm in Model.Properties.Where(p => !p.IsSelf))
{
    <text>    public override @Html.Raw(pm.TypeName)@(pm.IsNullable ? "?" : string.Empty) @pm.Name 
    { 
        get
        {
            if(_@pm.Name@{}IsSet)
            {
                return _@pm.Name;
            }
            throw new InvalidOperationException(s_notSet);
        }

    @if(!pm.IsPrimaryKey)
    {
        <text>        set
        {
            if(_processingInfo.ProcessingStage is ProcessingStage.Building || _processingInfo.ProcessingStage is ProcessingStage.Deserialization)
            {
                if(_@pm.Name != value){
                    if(!_@pm.Name@{}Used)
                    {
                        _@pm.Name = value;
                        _@pm.Name@{}IsSet = true;
        @if(Model.PocoKind is PocoKind.Entity)
        {
            <text>                        _changed = true;
</text>
        }
                    }
                    else
                    {
                        throw new InvalidOperationException(s_alreadyUsed);
                    }
                }
            }
            else
            {
                throw new InvalidOperationException(s_notBuildingDeserialization);
            }

        }
</text>
    }
    }
</text>
}
#endregion Properties
@if(Model.PocoKind is PocoKind.Entity)
{
    <text>    IEnumerable<object> @nameof(IPrimaryKey)@{}.GetPrimaryKey()
    {
@foreach (PropertyModel pm in Model.Properties.Where(v => v.IsPrimaryKey).OrderBy(v => v.Name))
{
    if(pm.PocoKind is PocoKind.Entity)
    {
        <text>        foreach (object pk in ((@nameof(IPrimaryKey))_@pm.Name).GetPrimaryKey())
        {
            yield return pk;
        }
</text>
    }
    else
    {
        <text>        yield return _@pm.Name;
</text>
    }
}
    }
    void @nameof(IEntity)@{}.AccessGiven()
    {
        if(_processingInfo.ProcessingStage is ProcessingStage.AccessGiving)
        {
            _accessGiven = true;
        }
        else
        {
            throw new InvalidOperationException(s_notAccessGiving);
        }
    }
    void @nameof(IEntity)@{}.AcceptChanges()
    {
        if(_processingInfo.ProcessingStage is ProcessingStage.Serialization)
        {
            _changed = false;
        }
        else
        {
            throw new InvalidOperationException(s_notSerialization);
        }
    }
@foreach (PropertyModel pm in Model.Properties.Where(v => v.IsPrimaryKey))
{
    <text>    internal void Set@{}@pm.Name@{}(@Html.Raw(pm.TypeName)@(pm.IsNullable ? "?" : string.Empty) value)
    {
        _@pm.Name = value;
    }
</text>
}
</text>
}
}