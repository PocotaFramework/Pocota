@using Net.Leksi.Pocota.Common;
@model ClassModel

    public class @Model.ClassName: @Html.Raw(string.Join(", ", Model.Interfaces))
    {

@Html.Partial("InitProperties", viewData: new ViewDataDictionary(ViewData) { { "Projection", true } })

        private readonly @Html.Raw(Model.Parent!.ClassName) _projector;

        @foreach(PropertyModel pm in Model.Properties.Where(p => p.IsList && p.Class is {}))
        {
            string fieldName = $"_{pm.Name.Substring(0, 1).ToLower()}{pm.Name.Substring(1)}";
            <text>        private readonly @Html.Raw($"ProjectionList<{pm.Class},{pm.ItemType}> {fieldName};")
</text>
        }

        @foreach(PropertyModel pm in Model.Properties)
        {
            <text>        public @Html.Raw(pm.Type)@if (pm.IsNullable) {<text>?</text> } @pm.Name 
        {
            get => @if(!pm.IsList || !pm.IsProjection){
                <text>@if (pm.IsProjection && !pm.IsList) {<text>@Html.Raw($"((IProjection{(pm.IsNullable ? "?" : string.Empty)})")</text>}@Html.Raw($"_projector.{pm.Name}")@if (pm.IsProjection && !pm.IsList) { <text>)@if (pm.IsNullable) {<text>?</text> }@Html.Raw($".As<{pm.Type}>()")</text>}@if (!pm.IsNullable) {<text>!</text> };
</text>
            }
            else {
                string fieldName = $"_{pm.Name.Substring(0, 1).ToLower()}{pm.Name.Substring(1)}";
                <text>@fieldName;
</text>
            }
            @if(!pm.IsReadOnly)
            {
                if(pm.IsList)
                {
                    <text>            set => throw new NotImplementedException();
</text>
                }
                else
                {
                <text>            set => @Html.Raw($"_projector.{pm.Name} = ")@if (pm.IsProjection) {<text>@Html.Raw($"((IProjection{(pm.IsNullable ? "?" : string.Empty)})")</text>} else {<text>@Html.Raw($"({(pm.Class is {} ? pm.Class : pm.Type)}{(pm.IsNullable ? "?" : string.Empty)})")</text>}@Html.Raw($"value{(!pm.IsNullable && pm.IsProjection ? "!" : string.Empty)}")@if (pm.IsProjection) { <text>)@Html.Raw($"?.As<{pm.Class}>()")</text>}@if (!pm.IsNullable) {<text>!</text> };
</text>
                }
            }
        }

</text>
        }

        internal @Html.Raw($"{Model.ClassName}({Model.Parent!.ClassName} projector)")
        {
            _projector = projector;
            @foreach(PropertyModel pm in Model.Properties.Where(p => p.IsList && p.Class is {}))
            {
                string fieldName = $"_{pm.Name.Substring(0, 1).ToLower()}{pm.Name.Substring(1)}";
                <text>            @fieldName = new(@Html.Raw($"(({Model.Parent!.ClassName})_projector).{pm.Name}"));
</text>
            }
        }

        public I? @Html.Raw("As<I>() where I : class")
        {
            return (I?)_projector.As(typeof(I))!;
        }

        public object? As(Type type) 
        {
            return _projector.As(type);
        }

        @foreach(MethodModel mm in Model.Methods)
        {
        string parameters = string.Join(", ", mm.Parameters.Select(p => p.Class is { } ? $"((IProjection<{p.Class}>){p.Name})?._projector!" : p.Name));
        <text>        public @Html.Raw(mm.ReturnType) @mm.Name@Html.Raw($"({string.Join(", ", mm.Parameters.Select(p => $"{p.Type} {p.Name}"))})")
        {
            @Html.Raw("")@if (!mm.ReturnType.Equals("void"))
            {
                <text>object? result = </text>
        }@Html.Raw($"(({Model.Parent!.ClassName})_projector).{mm.Name}({parameters})");
            @if (!mm.ReturnType.Equals("void"))
            {
                <text>            return @Html.Raw($"({mm.ReturnType})result");
</text>
            }
        }
</text>
        }

        public override bool Equals(object? obj)
        {
            return obj is @Html.Raw($"IProjection<{Model.Parent!.ClassName}>") other && object.ReferenceEquals(_projector, @Html.Raw($"other.As<{Model.Parent!.ClassName}>()"));
        }

        public override int GetHashCode()
        {
            return _projector.GetHashCode();
        }

        @Html.Partial("ProjectionPropertiesAccessors")

    }
