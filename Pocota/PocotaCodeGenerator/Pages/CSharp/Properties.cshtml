@using Net.Leksi.Pocota.Common;
@model ClassModel

@Html.Raw("#region Properties")

@foreach (PropertyModel pm in Model.Properties)
{
    string fieldName = $"_{pm.Name.Substring(0, 1).ToLower()}{pm.Name.Substring(1)}";
    <text>    public virtual @Html.Raw(pm.Type)@if (pm.IsNullable) {<text>?</text> } @pm.Name
    {
        get => @Html.Raw($"_is_set{fieldName}") ? @fieldName : default!;
    @if(!pm.IsReadOnly)
    {
        if(pm.IsList)
        {
            <text>        set => throw new NotImplementedException();
</text>
        }
        else
        {
            <text>        set
        {
            if(@fieldName != value)
            {
                lock(_lock)
                {
                    if(@fieldName != value @if(Model.IsEntity){<text> && (IsBeingPopulated || @Html.Raw($"_is_set{fieldName}"))</text>})
                    {
                        @if(pm.IsProjection)
                        {
                            <text>                        if(@fieldName is {})
                        {
                            @Html.Raw($"{fieldName}.PocoChanged -= {pm.Name}PocoChanged");
                        }
</text>   
                        }
                        @fieldName = value;
                        @if(pm.IsProjection)
                        {
                            <text>                        if(@fieldName is {})
                        {
                            @Html.Raw($"{fieldName}.PocoChanged += {pm.Name}PocoChanged");
                        }
</text>   
                        }
                        if (IsBeingPopulated)
                        {
                            @Html.Raw($"_initial{fieldName}") = value;
                        }
                        OnPocoChanged(@Html.Raw($"s{fieldName}Prop"));
                        OnPropertyChanged();
                    }
                }
            }
        }
</text>
            }
        }
    }

</text>
}
@Html.Raw("#endregion Properties");
